<!DOCTYPE html>
<html><head>
  <title>stash wishlist config</title>
  <style>
    html, input {
      background: #000;
      color: #ddd;
      border-color: #ddd;
      font-size: 1em;
    }
    .hero {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <pre id="config" class="hero" style="width: 50vw;">
    <input type="button" value="Sync local stash history" onclick="sync()">
  </pre>
  <script src="../assets/apis.js"></script>
  <script>
    const stashdb_host = localStorage.getItem("stashdb_host")
    const stashlist_server = {
        apikey: localStorage.getItem("stashlist_apikey"),
        host: localStorage.getItem("stashlist_host")
    }
    const localStash = {
        apikey: localStorage.getItem("localstash_apikey"),
        host: localStorage.getItem("localstash_host")
    }
    async function sync() {
        const query = `
            query FindScenes($endpoint: String!) {
            findScenes( scene_filter: {
                stash_id_endpoint: { endpoint: $endpoint modifier: NOT_NULL }
            } filter: { per_page: -1 }
            ) { scenes { stash_ids { stash_id }
        }}}`
        const variables = { endpoint: stashdb_host };
        const idlist = await gqlClient(localStash, query, variables)
            .then(data => data.findScenes.scenes)
            .then(scenes => scenes.map(scene => scene.stash_ids[0].stash_id))
        // sync to stashlist
        const saniList = [...new Set(idlist)]
        await stashlist.addbulk(saniList, "history")
    }
  </script>
</body></html>